<!DOCTYPE html>
<html>
<head>
  <title>Arquillian usage report</title>


  <script src="//code.jquery.com/jquery-2.1.1.js"></script>
  <script src="//code.highcharts.com/4.0.3/highcharts.js"></script>
  <script src="//code.highcharts.com/4.0.3/highcharts-more.js"></script>
  <script src="//code.highcharts.com/4.0.3/themes/dark-unica.js"></script>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  
  <style>
    html {
        overflow-y: scroll;
    }
    body {
      background-color: #2a2a2b;
      color: #E0E0E3;
    }
    .modal {
      color: #000;
    }
    .nav li.active {
      background-color: #eee;
    }
    .nav>li>a {
      padding: 5px 15px;
    }
    #chart {
      height: 400px;
    }
    .dependencies .version {
      text-align: right;
    }
  </style>
</head>

<body>
  <div class="row">
    <div class="col-md-2" id="menu"></div>
    <div class="col-md-9" id="content">
      <div id="chart">
      </div>
      <div id="data"></div>
    </div>
  </div>

  <div class="modal fade" id="module_usage" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
          <h4 class="modal-title">Module</h4>
        </div>
        <div class="modal-body">
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

<script>
  Array.prototype.unique = function() {
      var unique = [];
      for (var i = 0; i < this.length; i++) {
          if (unique.indexOf(this[i]) == -1) {
              unique.push(this[i]);
          }
      }
      return unique;
  };
  var create_project_graph = function(set) {
    if(typeof window.$chart === "undefined") {
      window.$chart = new Highcharts.Chart({
          chart: {
              type: 'column',
              backgroundColor: "#2a2a2b",
              renderTo: "chart"
          },
          credits: {
            enabled: false
          },
          title: {
              text: set.name
          },
          xAxis: {
              categories: set.categories
          },
          yAxis: {
              min: 0,
              title: {
                  text: 'Total'
              }
          },
          legend: {
              reversed: true
          },
          plotOptions: {
              series: {
              }
          },
          series: set.data
      })
    } else {
      window.$chart.xAxis.forEach(function(value) {
        value.remove(false);
      })
      window.$chart.series.forEach(function(value) {
        value.remove(false)
      })
      window.$chart.addAxis({categories: set.categories}, true, false);
      set.data.forEach(function(value) {
        window.$chart.addSeries(value, false);
      })
      window.$chart.setTitle({text: set.name}, {}, false);
      $('#chart > div').replaceWith(window.$chart.container)
      window.$chart.redraw();
      
    }
  }
  var convert_project_data = function(project) {
    var categories = ['Classes', 'Deployments', 'Tests', 'Assertions']
    

    var totals = new Array();
    project.repos.forEach(function(repo) {
      totals.push(
        {
          name: repo.name, 
          data: [
            repo.sum.classes,
            repo.sum.deployments,
            repo.sum.tests,
            repo.sum.assertions
          ]
        })
    })

    return {
      name: project.name,
      categories: categories,
      data: totals
    }
  };
  var create_project = function(project) {
    
    var content = "";

    content += '<div class="row">'
        content += '<div class="row">'
          content += '<div class="col-md-12 page-header">'
            content += '<h2>' + project.name +'</h2>'
          content += '</div>'
        content += '<div class="row">'
          content += '<div class="col-md-2">Classes</div>'
          content += '<div class="col-md-2">Deployments</div>'
          content += '<div class="col-md-2">Tests</div>'
          content += '<div class="col-md-2">Assertions</div>'
          content += '<div class="col-md-2">Lines</div>'
        content += '</div>'
        content += '<div class="row">'
          content += '<div class="col-md-2">' + project.sum.classes.toLocaleString() +'</div>'
          content += '<div class="col-md-2">' + project.sum.deployments.toLocaleString() +'</div>'
          content += '<div class="col-md-2">' + project.sum.tests.toLocaleString() +'</div>'
          content += '<div class="col-md-2">' + project.sum.assertions.toLocaleString() +'</div>'
          content += '<div class="col-md-2">' + project.sum.lines.toLocaleString() +'</div>'
        content += '</div>'
      content += '</div>'

    project.repos.sort(function(a, b) {
      if(a.sum.assertions < b.sum.assertions ) {
        return 1;
      }
      if(a.sum.assertions > b.sum.assertions ) {
        return -1;
      }
      return 0;
    })
    project.repos.forEach(function(repo) {
      content += '<div class="repo row">'
      content += '<h3>' + repo.name + ' <small>' + repo.git + '</small></h3>'
      content += '<div class="col-md-8">'
      content += '<div class="row dependencies">'
      
      repo.dependencies.sort(function(a, b) {
        if(a.name > b.name) {
          return 1
        }
        if(a.name < b.name) {
          return -1
        }
        return 0
      })

      repo.dependencies.forEach(function(dep) {
        if(dep.name !== 'Other' && dep.name !== 'Internal') {
          content += '<div class="col-md-6 name"><a data-module="' + dep.name + '" data-toggle="modal" data-target="#module_usage">' + dep.name + '</a></div>'
          content += '<div class="col-md-6 version">' + (dep.version == null ? 'n/a':dep.version) + '</div>'
        }
      })
      content += '</div>'
      content += '</div>'
      content += '<dl class="sum col-md-3 dl-horizontal">'
      content += '<dt>Classes</dt>'
      content += '<dd class="right">' + repo.sum.classes.toLocaleString() +'</dd>'
      content += '<dt>Deployments</dt>'
      content += '<dd>' + repo.sum.deployments.toLocaleString() +'</dd>'
      content += '<dt>Tests</dt>'
      content += '<dd>' + repo.sum.tests.toLocaleString() +'</dd>'
      content += '<dt>Assertions</dt>'
      content += '<dd class="right">' + repo.sum.assertions.toLocaleString() +'</dd>'
      content += '<dt>Lines</dt>'
      content += '<dd class="right">' + repo.sum.lines.toLocaleString() +'</dd>'
      content += '</dl>'

      content += '</div>'
    })

    $("#data").html(content)
  }
  var create_menu = function(data) {
    data.sort(function(a, b) {
      if(a.name > b.name) {
        return 1
      }
      if(a.name < b.name) {
        return -1
      }
      return 0
    })

    var content = '<nav class="navbar"><ul class="nav nav-stacked">'
    content += '<li><a href="#"><i class="glyphicon glyphicon-home" /> Overview</a></li>' 
    data.forEach(function(project) {
      content += '<li><a href="#' + project.name + '">' + project.name + '</a></li>' 
    })
    content += '</ul></nav>'

    $("#menu").html(content)
    $('.nav li').click(function(e) {
        $('.nav li.active').removeClass('active');
        var $this = $(this);
        if (!$this.hasClass('active')) {
            $this.addClass('active');
        }
    });
  }
  var filter_data = function(hash, data) {
    for(var i = 0; i < data.length; i++) {
      var project = data[i];
      if(project.name === hash) {
        return project;
      }
    }
    return {}
  }
  var display_project = function(name, data) {
    var filtered = filter_data(name, data);
    create_project_graph(convert_project_data(filtered));
    create_project(filtered);
  }
  var display_overview = function(data) {
    reset()
    var classes = 0;
    var deployments = 0;
    var tests = 0;
    var assertions = 0;
    var lines = 0;
    data.forEach(function(project) {
      classes += project.sum.classes;
      deployments += project.sum.deployments;
      tests += project.sum.tests;
      assertions += project.sum.assertions;
      lines += project.sum.lines;
    })

    var content = "";
    content += '<div class="row">'
      content += '<div class="col-md-2">Classes</div>'
      content += '<div class="col-md-2">Deployments</div>'
      content += '<div class="col-md-2">Tests</div>'
      content += '<div class="col-md-2">Assertions</div>'
      content += '<div class="col-md-2">Lines</div>'
    content += '</div>'
    content += '<div class="row">'
      content += '<div class="col-md-2">' + classes.toLocaleString() +'</div>'
      content += '<div class="col-md-2">' + deployments.toLocaleString() +'</div>'
      content += '<div class="col-md-2">' + tests.toLocaleString() +'</div>'
      content += '<div class="col-md-2">' + assertions.toLocaleString() +'</div>'
      content += '<div class="col-md-2">' + lines.toLocaleString() +'</div>'
    content += '</div>'

    $("#overview_sum").html(content)

    var overview_charts = new Array();
    
    var categories = ['Lines', 'Assertions', 'Tests', 'Deployments', 'Classes' ]
    categories.forEach(function(cat) {
      var project_data = new Array();
      data.forEach(function(project) {
        project_data.push([project.name, project.sum[cat.toLowerCase()]])
      })
      overview_charts.push({type: cat, data: project_data})
    })
    overview_charts.forEach(function(value) {
      new Highcharts.Chart({
          chart: {
              type: 'column',
              backgroundColor: "#2a2a2b",
              renderTo: value.type.toLowerCase() + "_chart"
          },
          credits: {
            enabled: false
          },
          title: {
              text: value.type + ' pr project'
          },
          xAxis: {
            type: 'category',
            labels: {
              rotation: -45,
            }
          },
          yAxis: {
              min: 0,
              title: {
                  text: value.type
              }
          },
          legend: {
              enabled: false
          },
          plotOptions: {
            series: {
              point: {
                events: {
                  click: function() {
                    window.location.hash='#' + this.name
                  }
                }
              }    
            }
          },
          series: [{
            name: value.type,
            data: value.data,
            dataLabels: {
              enabled: false,
              rotation: -90,
              x: 4,
              y: 10,
            }          
          }]
      })
    })
  }
  var display_module_overview = function(target, type, data) {
    var content = '';

    var usage = new Array();
    var versions = new Array();

    data.forEach(function(project) {
      project.repos.forEach(function(repo) {
        repo.dependencies.forEach(function(dep) {
          if(dep.name === type) {
            usage.push(project.name);
            versions.push(dep.version)
          }
        })
      })
    })

    usage = usage.unique().sort()
    versions = versions.unique().sort();

    content += '<ul>'
    usage.forEach(function(project) {
      content += '<li>' + project +'</li>'
    })
    content += '</ul>'


    $(target).find(".modal-title").html(type + "<br/><small>" + versions.join(', ') + "</small>")
    $(target).find(".modal-body").html(content)
  }
  var reset = function() {
    window.$chart = undefined
    $('#chart').html('<div class="page-header"> \
          <h1 class="panel-title">Arquillian Usage <small>within Red Hat JBoss</small></h1> \
        </div> \
        <div id="overview_sum"> \
          loading.. \
        </div> \
        <div id="lines_chart"> \
        </div> \
        <div id="assertions_chart"> \
        </div> \
        <div id="tests_chart"> \
        </div> \
        <div id="deployments_chart"> \
        </div> \
        <div id="classes_chart"> \
        </div>');
    $('#data').html('');
  }
  $(function() {
    reset();
    $.ajax({
      url: 'result.json',
      dataType: 'json',
      success: function(data, status) {
        create_menu(data);
        
        $(window).on('hashchange', function(event) {
          var hash = event.target.location.hash.substring(1);
          if(hash === '') {
            display_overview(data)
          } else {
            display_project(hash, data);
          }
        })
        if(window.location.hash) {
          $("a[href=" + window.location.hash + "]").parent().addClass("active");
          display_project(window.location.hash.substring(1), data);
        } else {
          display_overview(data);
        }

        $(window).on("show.bs.modal", function(event) {
          display_module_overview($(event.target), event.relatedTarget.getAttribute('data-module'), data)
        })
      }
    });
  });

</script>